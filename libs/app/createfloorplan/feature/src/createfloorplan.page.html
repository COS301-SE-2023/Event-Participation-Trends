<!-- <subpagenav [currentPage]="'/home/createfloorplan'"></subpagenav> -->

<ion-content [fullscreen]="true">
  <div class="grid grid-cols-12 gap-3 p-3 h-full">
    <div
      class="tool-menu col-span-2 rounded-lg md:rounded-xl shadow-[0px_5px_15px_2px_rgba(0,0,0,0.2)] text-ept-deep-grey relative"
      ngClass="card-container"
    >
      <div ngClass="card" [class.flipped]="isCardFlipped && isSensor()">
        <div ngClass="front-side">
          <div class="flex flex-row justify-evenly">
            <h1 class="text-lg font-semibold text-center mt-5">Tools</h1>
            <ion-button
              id="hover-trigger"
              *ngIf="isSensor()"
              class="mt-4 rounded-lg overflow-hidden self-center bg-ept-deep-grey hover:scale-105 duration-300 transition-all"
              title="Click to view linked sensors"
              (click)="toggleCardFlip()"
            >
              <ion-icon name="repeat" class="w-8 h-8"></ion-icon>
            </ion-button>
          </div>
          <h3
            class="components-heading flex justify-between items-center mt-6 ml-2"
          >
            Components
          </h3>
          <div class="components-list mb-1 overflow-hidden">
            <div
              class="overflow-y-auto max-h-52 flex"
              [ngClass]="{'disabled opacity-50 pointer-events-none': !preventCreatingWalls}"
            >
              <img
                id="sensorImage"
                class="border-2 rounded-lg p-1 w-10 h-10 mt-2 cursor-grab"
                draggable="true"
                (dragstart)="onDragStart($event)"
                src="assets/sensor.png"
                alt="sensor"
              />
              <ion-text class="text-ept-deep-grey opacity-40 mt-4 ml-4"
                >Sensor</ion-text
              >
            </div>
            <div
              class="overflow-y-auto max-h-52 flex"
              [ngClass]="{'disabled opacity-50 pointer-events-none': !preventCreatingWalls}"
            >
              <img
                class="border-2 rounded-lg p-1 w-10 h-10 mt-2 cursor-grab"
                #stall
                draggable="true"
                (dragstart)="onDragStart($event)"
                src="assets/stall-icon.png"
                alt="stall"
              />
              <ion-text class="text-ept-deep-grey opacity-40 mt-4 ml-4"
                >Stall</ion-text
              >
            </div>
          </div>
          <h3 class="attributes-heading mt-3 ml-2">Component Attributes</h3>
          <div
            *ngIf="!shouldStackVertically"
            id="attributes-container"
            class="flex flex-col cursor-default"
          >
            <ion-item class="attributes-list flex mt-2" lines="none">
              <ion-label class="ion-col-4 mr-3 min-w-fit" [ngClass]="{'opacity-50' : !preventCreatingWalls || activeItem == null || !selectedWall}">Length:</ion-label>
              <ion-input
                aria-label=""
                class="ion-col-8 input-field input focus:outline-none focus:ring-2 focus:ring-blue-500 mr-10 border-2 rounded h-7"
                type="number"
                step="1"
                [value]="activeItem ? getActiveItemRotation() : 0"
                (input)="updateWidth($event)"
                [disabled]="!preventCreatingWalls || activeItem == null|| !selectedWall"
              ></ion-input>
            </ion-item>
            <ion-item class="attributes-list flex mt-2" lines="none">
              <ion-label class="ion-col-4 mr-3 min-w-fit" [ngClass]="{'opacity-50' : !preventCreatingWalls || activeItem == null}">Angle:</ion-label>
              <ion-input
                aria-label=""
                class="ion-col-8 input-field input focus:outline-none focus:ring-2 focus:ring-blue-500 mr-10 border-2 rounded h-7"
                type="number"
                step="1"
                [value]="activeItem ? getActiveItemRotation() : 0"
                (input)="updateRotation($event)"
                [disabled]="!preventCreatingWalls || activeItem == null"
              ></ion-input>
            </ion-item>
          </div>
          <div
            *ngIf="shouldStackVertically"
            id="attributes-container"
            class="flex flex-col items-center justify-evenly"
          >
            <div class="mt-3">
              <ion-label [ngClass]="{'opacity-50' : !preventCreatingWalls || activeItem == null || !selectedWall}">Length:</ion-label>
              <ion-input
                aria-label=""
                class="input-field input focus:outline-none focus:ring-2 focus:ring-blue-500 border-2 rounded h-7"
                type="number"
                step="1"
                [value]="activeItem ? getActiveItemRotation() : 0"
                (input)="updateWidth($event)"
                [disabled]="!preventCreatingWalls || activeItem == null || !selectedWall"
              ></ion-input>
            </div>
            <div class="mt-3">
              <ion-label [ngClass]="{'opacity-50' : !preventCreatingWalls || activeItem == null}">Angle:</ion-label>
              <ion-input
                aria-label=""
                class="input-field input focus:outline-none focus:ring-2 focus:ring-blue-500 border-2 rounded h-7"
                type="number"
                step="1"
                [value]="activeItem ? getActiveItemRotation() : 0"
                (input)="updateRotation($event)"
                [disabled]="!preventCreatingWalls || activeItem == null"
              ></ion-input>
            </div>
          </div>

          <div class="mt-2 text-center">
            <div class="flex flex-row justify-evenly items-center mb-4">
              <ion-label [ngClass]="{'opacity-50' : !preventCreatingWalls}">Component Selection</ion-label>
              <ion-toggle
                aria-label="Warning toggle"
                [checked]="!preventCreatingWalls"
                class="col-span-1"
                (ionChange)="toggleEditing()"
              ></ion-toggle>
              <ion-label [ngClass]="{'opacity-50' : preventCreatingWalls}">Wall Creation</ion-label>
            </div>
          </div>

          <ion-button
            (click)="saveFloorLayout()"
            class="create-event mt-20 ml-20 right-2.5 h-40px text-ept-off-white text-sm/16 rounded-lg bg-green-500 drop-shadow-lg absolute bottom-0 mb-10 hover:scale-102 hover:bg-opacity-100 hover:shadow-[0px_2px_7px_2px_rgba(0,0,0,0.2)]"
            >Save
          </ion-button>
        </div>
        <div ngClass="back-side">
          <div class="flex flex-row justify-evenly">
            <h1 class="text-lg font-semibold text-center mt-5">Link Sensors</h1>
            <ion-button
              id="hover-trigger"
              class="mt-4 rounded-lg overflow-hidden self-center bg-ept-deep-grey hover:scale-105 duration-300 transition-all"
              title="Click to view Tools"
              (click)="toggleCardFlip()"
            >
              <ion-icon name="repeat" class="w-8 h-8"></ion-icon>
            </ion-button>
          </div>
          <hr class="mt-3 mb-3" />
          <!-- <div class="flex flex-col text-center">
            <ion-label class="text-ept-deep-grey opacity-40">Selected Sensor Id:</ion-label>
            <ion-text class="text-ept-deep-grey font-bold m-auto opacity-1">{{getSelectedSensorId()}}</ion-text>
          </div>
          <div class="mt-5 text-center">
            <ion-label class="text-ept-deep-grey opacity-40"
              >Select a sensor to link with:</ion-label
            >
            <ion-list>
              <ion-item *ngFor="let sensorId of SensorIds">
                <ion-checkbox>
                  <ion-label>{{sensorId}}</ion-label>
                </ion-checkbox>
              </ion-item>
            </ion-list>
            <ion-text
              class="text-red-500 font-bold m-auto opacity-1"
              *ngIf="SensorIds.length === 0"
              >No sensors found</ion-text
            >
          </div>
          <ion-button
            (click)="updateLinkedSensors()"
            class="create-event mt-20 ml-20 right-2.5 h-40px text-ept-off-white text-sm/16 rounded-lg bg-green-500 drop-shadow-lg absolute bottom-0 mb-10 hover:scale-102 hover:bg-opacity-100 hover:shadow-[0px_2px_7px_2px_rgba(0,0,0,0.2)]"
          >Save changes</ion-button> -->
          <div id="reader" width="w-full"></div>
          <ion-label class="text-ept-deep-grey opacity-40"
            >Alternative:</ion-label
          >
          <form [formGroup]="macAddressForm">
            <div class="mt-4 flex flex-col items-center justify-evenly">
              <div class="flex items-center">
                <ion-input
                  id="macAddressBlock1"
                  aria-label="MAC Address Block"
                  class="bg-slate-200 w-7 uppercase border-2 rounded-md"
                  type="text"
                  maxlength="2"
                  (input)="handleMacAddressInput($event, 0)"
                  (ionFocus)="setInputFocus(true)"
                  (ionBlur)="setInputFocus(false)"
                  name="macAddressBlock1"
                  formControlName="macAddressBlock1"
                  [ngClass]="{ 'border-2 border-rose-500': macAddressBlock1?.hasError('required') && (macAddressBlock1?.dirty || macAddressBlock1?.touched), 'border-2 border-green-400' : macAddressBlock1?.valid && (macAddressBlock1?.dirty || macAddressBlock1?.touched)}"
                  ></ion-input>
                  <span class="ml-1 mr-1">:</span>
                  <ion-input
                  id="macAddressBlock2"
                  aria-label="MAC Address Block"
                  class="bg-slate-200 w-7 uppercase border-2 rounded-md"
                  type="text"
                  maxlength="2"
                  (input)="handleMacAddressInput($event, 1)"
                  (ionFocus)="setInputFocus(true)"
                  (ionBlur)="setInputFocus(false)"
                  name="macAddressBlock2"
                  formControlName="macAddressBlock2"
                  [ngClass]="{ 'border-2 border-rose-500': macAddressBlock2?.hasError('required') && (macAddressBlock2?.dirty || macAddressBlock2?.touched), 'border-2 border-green-400' : macAddressBlock2?.valid && (macAddressBlock2?.dirty || macAddressBlock2?.touched)}"
                ></ion-input>
                <span class="ml-1 mr-1">:</span>
                <ion-input
                  id="macAddressBlock3"
                  aria-label="MAC Address Block"
                  class="bg-slate-200 w-7 uppercase border-2 rounded-md"
                  type="text"
                  maxlength="2"
                  (input)="handleMacAddressInput($event, 2)"
                  (ionFocus)="setInputFocus(true)"
                  (ionBlur)="setInputFocus(false)"
                  name="macAddressBlock3"
                  formControlName="macAddressBlock3"
                  [ngClass]="{ 'border-2 border-rose-500': macAddressBlock3?.hasError('required') && (macAddressBlock3?.dirty || macAddressBlock3?.touched), 'border-2 border-green-400' : macAddressBlock3?.valid && (macAddressBlock3?.dirty || macAddressBlock3?.touched)}"
                ></ion-input>
                <span class="ml-1 mr-1">:</span>
                <ion-input
                  id="macAddressBlock4"
                  aria-label="MAC Address Block"
                  class="bg-slate-200 w-7 uppercase border-2 rounded-md"
                  type="text"
                  maxlength="2"
                  (input)="handleMacAddressInput($event, 3)"
                  (ionFocus)="setInputFocus(true)"
                  (ionBlur)="setInputFocus(false)"
                  name="macAddressBlock4"
                  formControlName="macAddressBlock4"
                  [ngClass]="{ 'border-2 border-rose-500': macAddressBlock4?.hasError('required') && (macAddressBlock4?.dirty || macAddressBlock4?.touched), 'border-2 border-green-400' : macAddressBlock4?.valid && (macAddressBlock4?.dirty || macAddressBlock4?.touched)}"
                ></ion-input>
                <span class="ml-1 mr-1">:</span>
                <ion-input
                  id="macAddressBlock5"
                  aria-label="MAC Address Block"
                  class="bg-slate-200 w-7 uppercase border-2 rounded-md"
                  type="text"
                  maxlength="2"
                  (input)="handleMacAddressInput($event, 4)"
                  (ionFocus)="setInputFocus(true)"
                  (ionBlur)="setInputFocus(false)"
                  name="macAddressBlock5"
                  formControlName="macAddressBlock5"
                  [ngClass]="{ 'border-2 border-rose-500': macAddressBlock5?.hasError('required') && (macAddressBlock5?.dirty || macAddressBlock5?.touched), 'border-2 border-green-400' : macAddressBlock5?.valid && (macAddressBlock5?.dirty || macAddressBlock5?.touched)}"
                ></ion-input>
                <span class="ml-1 mr-1">:</span>
                <ion-input
                  id="macAddressBlock6"
                  aria-label="MAC Address Block"
                  class="bg-slate-200 w-7 uppercase border-2 rounded-md"
                  type="text"
                  maxlength="2"
                  (input)="handleMacAddressInput($event, 5)"
                  (ionFocus)="setInputFocus(true)"
                  (ionBlur)="setInputFocus(false)"
                  name="macAddressBlock6"
                  formControlName="macAddressBlock6"
                  [ngClass]="{ 'border-2 border-rose-500': macAddressBlock6?.hasError('required') && (macAddressBlock6?.dirty || macAddressBlock6?.touched), 'border-2 border-green-400' : macAddressBlock6?.valid && (macAddressBlock6?.dirty || macAddressBlock6?.touched)}"
                ></ion-input>
              </div>
              <ion-button
                class="mt-3 bg-ept-deep-grey rounded-md"
                disabled="{{!canLinkSensorWithMacAddress}}"
                (click)="updateLinkedSensors()"
                >Link Sensor</ion-button
              >
            </div>
          </form>
          <div *ngIf="activeSensor$ | async as sensor" class="mt-3 flex flex-row justify-evenly">
            <ion-text class="text-ept-deep-grey">Sensor Status:</ion-text>
            <ion-badge
            color="{{ sensor['isLinked'] ? 'success' : 'danger' }}"
            class="text-ept-off-white"
            >{{ sensor['isLinked'] ? 'Linked' : 'Not Linked' }}</ion-badge>
          </div>
        </div>
      </div>
    </div>
    <div
      id="canvasParent"
      #canvasParent
      class="relative col-span-10 border-4 border-black rounded-lg md:rounded-xl shadow-[0px_5px_15px_2px_rgba(0,0,0,0.2)] text-ept-deep-grey p-2"
      (drop)="onDrop($event)"
      (dragover)="onDragOver($event)"
    >
      <p
        class="bg-white z-50 rounded-md text-center text-2xl text-ept-deep-grey text-opacity-30 font-semibold mt-10 absolute top-1/2 left-1/3"
        *ngIf="canvasItems.length === 0 && preventCreatingWalls"
      >
        Drag a component to the canvas
      </p>
      <p
        class="bg-white z-50 rounded-md text-center text-2xl text-ept-deep-grey text-opacity-30 font-semibold mt-10 absolute top-1/2 left-1/3"
        *ngIf="canvasItems.length === 0 && !preventCreatingWalls"
      >
        Click and drag to create walls
      </p>
      <div
        id="canvasElement"
        #canvasElement
        class="border-ept-off-white border-2 rounded-lg md:rounded-xl w-full h-full"
      ></div>
      <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
        <img
          #dustbin
          *ngIf="canvasItems.length > 0"
          class="dustbin"
          (dragover)="onDustbinDragOver($event)"
          (dragleave)="onDustbinDragLeave($event)"
          (mouseup)="onDustbinMouseUp($event)"
          [ngClass]="{'drag-over': openDustbin}"
          [src]="chooseDustbinImage()"
          alt="trash"
          class="bg-white h-10 transition-all duration-300"
        />
      </div>
      <div class="absolute bottom-3 right-1 bg-ept-off-white">
        <ion-label id="scaleLabel" class="text-ept-deep-grey p-0.5 rounded">1 Block = {{gridSizeLabel}}m</ion-label>
        <br/>
        <ion-label id="scaleLabel" class="text-ept-deep-grey p-0.5 rounded">1 Snap = {{snapLabel}}m</ion-label>
      </div>
      <div class="absolute bottom-3 left-2.5 flex flex-row bg-ept-off-white">
        <div>
          <img
            class="h-8 w-8 mr-1 border-2 p-0.5 border-ept-deep-grey cursor-pointer"
            src="assets/zoom-in-svgrepo-com.svg"
            alt="zoom in"
            (click)="zoomIn()"
            [ngClass]="{'opacity-50 pointer-events-none border-opacity-50': zoomInDisabled}"
          >
        </div>
        <div>
          <img
            class="h-8 w-8 border-2 p-0.5 border-ept-deep-grey cursor-pointer"
            src="assets/zoom-out-svgrepo-com.svg"
            alt="zoom out"
            (click)="zoomOut()"
            [ngClass]="{'opacity-50 pointer-events-none border-opacity-50': zoomOutDisabled}"
          >
        </div>
      </div>
    </div>
  </div>
  <ion-toast
    [isOpen]="preventCreatingWalls"
    message="Wall Creation Disabled"
    [duration]="2000"
    class="text-center"
    color="danger"
  ></ion-toast>
  <ion-toast
    [isOpen]="!preventCreatingWalls"
    message="Wall Creation Enabled"
    [duration]="2000"
    class="text-center"
    color="success"
  ></ion-toast>
</ion-content>
